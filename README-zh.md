# 农历

[![zh](https://img.shields.io/badge/lang-zh-red.svg)](README-zh.md)
[![en](https://img.shields.io/badge/lang-en-blue.svg)](README-en.md)

农历是中国的传统历法，依据太阳和月球的预报位置和一定的日期编排规则，由[中国科学院紫金山天文台](http://www.pmo.cas.cn/)依据国家标准 [GB/T 33661-2017](https://std.samr.gov.cn/gb/search/gbDetailed?id=71F772D817FDD3A7E05397BE0A0AB82A) 负责编算发行。作为特殊的阴阳合历，农历既能反映季节、农时和物候特征，又能体现月相变化和潮汐大小等自然现象，在日常生活、农业生产、渔业生产、防汛抗洪、航海实践等方面具有广泛的应用价值。

## 数据

若导出到 `fit/data.hpp` 中 1900 至 2199 年的数据已经足够，则本节可以跳过。

### 环境配置

执行如下命令配置环境：

```bash
cd data/
conda env create -f environment.yml
conda activate Nongli
```

### 爬取原始数据

执行如下命令获取原始数据并导出到 `data/build/raw.txt`：

```bash
cd data/
python -u spider.py
```

爬虫脚本中的 `MIN` 和 `MAX` 可以按需修改。由于“超级万年历”拟合算法的精度有限，-4712 A.D.（4713 B.C.）以前和 9999 A.D. 以后的计算很可能不准确。

### 重排数据

历史上月份序号发生过多次变动，但为方便起见，均用现在的历法排列当时的年份、月份。执行如下命令将重排后的朔与节气信息导出到 `data/build/` 目录下：

```bash
cd data/
python -u split.py
```

笔记本代码中的 `MIN` 和 `MAX` 可以按需修改，但不能超过原始数据的范围。特别提醒：本仓库不适用于计算和研究**历史上**三国及以前**实际**采用的历法。

### 生成 C++ 数据文件

用 Jupyter Notebook 打开 `data/coefs.ipynb`，运行所有代码，将生成的拟合参数与残差数据导出到 `fit/data.hpp`。

## 拟合

所有拟合与真太阳时校正均采用整数和定点数的加、减、乘法和位运算，避免浮点运算，以加快计算速度。从 C++20 开始，语言标准规定有符号整数右移为算术右移。事实上，绝大多数编译器一直以来都这样实现右移，因此假设用户的编译器在按照 C++17 标准编译时也是如此。

### 运行测试样例

若使用 GCC 或 Clang 编译器和 Make 构建工具，执行如下命令：

```bash
cd fit/
mkdir build/ && cd build/
cmake ..
make
./test # or './test.exe' if on Windows
```

若使用 MSVC 编译器和 NMAKE 构建工具，则执行如下命令：

```bash
cd fit/
mkdir build/ && cd build/
cmake ..
cmake --build . --config Release
./Release/test.exe
```

### 日期

本仓库代码中，`nian`（年）指从一个春节（正月初一）到下一个春节之前的时间。月份编码 `ryue` 为 2、3……24、25 分别对应正月、闰正月……十二月、闰十二月。农历十一月、十二月也分别称为冬月、腊月。

> 1970 年对应 Unix 时间戳从 3081600 秒到 33753600 秒之前的时间。

### 生日

农历生日是指与出生当日的月份和天数都相同的日子。如果出生当日逢三十，在对应月份只有 29 天的年份，在该月廿九过生日。如果出生于闰月，在没有对应闰月的年份，在对应非闰月过生日；在有对应闰月的年份，在对应闰月过生日。

> 出生于 1987 年正月初一的人，每年正月初一过生日。\
> 出生于 2004 年二月三十的人，2024 年在二月廿九过生日。\
> 出生于 2004 年闰二月十六的人，2022 年在二月十六过生日，2023 年在闰二月十六过生日。

### 节气

本仓库代码中，`sui`（岁）指从一个冬至到下一个冬至之前的时间。节气序号为 0、1……23 分别对应冬至、小寒……大雪，其中逢奇数序号为节令，逢偶数序号为中气。

> 1970 岁对应 Unix 时间戳从 -861379 秒到 30695740 秒之前的时间。

### 星座

星座**不属于**农历，但由太阳视黄经确定，即与农历节气对应。星座序号为 0、1……11 分别对应白羊、金牛……双鱼。从白羊（春分）开始，每逢中气（春分、谷雨……雨水）进入下一星座。

### 干支

干支是天干（甲、乙……癸）和地支（子、丑……亥）的合称，两两相配用于循环计数，60 为一周期。干支序号为 0、1……59 分别对应甲子、乙丑……癸亥。

### 伏天

从夏至当日起，第三个庚日进入头伏（初伏），第四个庚日进入二伏（中伏）；从立秋当日起，第一个庚日进入三伏（末伏）。头伏 10 天，二伏 10 天或 20 天，三伏 10 天，一共 30 天或 40 天。

### 数九

从冬至当日起，每九天为一个“九”，一共 9 个“九”，81 天。

### 八字

生辰八字由出生的日期时间决定，年、月、日、时共四柱，每柱干支两字。古代白天以日晷测量的时间（真太阳时）为准，钟表时间（平太阳时）要按照出生地经度校正到地方时，还要利用天文学算法计算其与真太阳时的差距，得到出生的真太阳时。

#### 年柱

以立春为分界点，每逢立春进入下一“年”。值得一提的是，生肖（鼠、牛……猪）虽然也与地支对应，但习惯上以春节为分界点。

> 1984 岁的立春进入甲子年。

#### 月柱

以节令为分界点，每逢节令（立春、惊蛰……小寒）进入下一“月”。

> 2023 岁的大雪进入甲子月。

#### 日柱

以地方时真太阳时 0 点（子正）为分界点，每逢 0 点进入下一“日”，但不进入下一“时”。

> 在东经 120°，Unix 时间戳 1735185600 秒所在日为甲子日。

#### 时柱

以地方时真太阳时奇数点整（子初 23 点、丑初 1 点……亥初 21 点）为分界点，每逢奇数点进入下一“时”。

> 在东经 120°，Unix 时间戳 1738598400 秒所在时辰为甲子时。

## 说明

* 原始数据来源于[超级万年历](https://www.sxwnl.com/super/)。
* 本仓库不考虑 1985 年至 1991 年夏季中国曾实行的夏令时，即不区分“北京时间”与“UTC+8”。
* 本仓库计算所得八字仅供参考，正所谓“神仙难断子时命”，在临界点附近，微小误差也可能导致排盘不准确。
* 八字及星座与人的性格、命理等的关系并无科学依据，请相信科学，切勿迷信；本仓库不承担一切不利后果。

## 致谢

* 感谢许剑伟先生及其开发的“超级万年历”网站。
* 感谢赵语涵女士提供农历闰月过生日的详细规则。